#!/usr/bin/env node

import { Command } from 'commander';
import commands from '../src/commands/index.js';
import { readFileSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import { ErrorHandler } from '../src/core/errors.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

let packageJson;
try {
  packageJson = JSON.parse(readFileSync(join(__dirname, '../package.json'), 'utf8'));
} catch (error) {
  console.error('Failed to read package.json:', error.message);
  process.exit(1);
}

const program = new Command();

program
  .name('specjet')
  .description('üöÄ SpecJet - API contract collaboration tool\nDesign APIs together, build separately, integrate seamlessly')
  .version(packageJson.version)
  .option('--verbose', 'Enable verbose output for debugging and error details')
  .option('--config <path>', 'Path to configuration file (default: ./specjet.config.js)')
  .addHelpText('after', `
Examples:
  $ specjet init my-api             Initialize a new project
  $ specjet generate                Generate TypeScript types from contract
  $ specjet generate --watch        Generate and watch for changes
  $ specjet mock                    Start mock server on port 3001
  $ specjet mock --port 8080        Start mock server on custom port
  $ specjet mock --scenario large   Start mock server with large dataset  
  $ specjet docs                    Start documentation server on port 3002
  $ specjet docs --port 8081        Start documentation server on custom port

Documentation:
  https://docs.specjet.dev

For more help on a specific command:
  $ specjet <command> --help
`);

// specjet init [project-name]
program
  .command('init')
  .description('üéØ Initialize a new SpecJet project with contract and configuration')
  .argument('[project-name]', 'Name of the project directory to create (default: current directory)')
  .option('--template <template>', 'Template to use: basic (default: basic)', 'basic')
  .option('--project <id>', 'Link to existing web platform project ID (future feature)')
  .option('--force', 'Overwrite existing files')
  .addHelpText('after', `
Examples:
  $ specjet init                   Initialize in current directory
  $ specjet init my-api            Initialize a new project
  $ specjet init --template basic  Use the basic template (default)

What this creates:
  ‚Ä¢ specjet.config.js     Configuration file
  ‚Ä¢ api-contract.yaml     OpenAPI contract template
  ‚Ä¢ src/types/            Generated TypeScript types (gitignored)
  ‚Ä¢ src/api/              Generated API client (gitignored)
`)
  .action(commands.init);

// specjet generate [options]
program
  .command('generate')
  .description('üîß Generate TypeScript types and API client from OpenAPI contract')
  .option('-w, --watch', 'Watch mode - automatically regenerate when contract changes')
  .option('-o, --output <dir>', 'Custom output directory for generated files')
  .option('-c, --config <path>', 'Path to configuration file')
  .addHelpText('after', `
Examples:
  $ specjet generate               Generate TypeScript types from contract
  $ specjet generate --watch       Generate and watch for changes
  $ specjet generate --output dist Custom output directory
Generated files:
  ‚Ä¢ src/types/api.ts      TypeScript interfaces for all schemas
  ‚Ä¢ src/api/client.ts     Typed API client with all endpoints

Watch mode:
  Automatically regenerates when your OpenAPI contract changes.
  Perfect for development workflows. Press Ctrl+C to stop watching.
`)
  .action(commands.generate);

// specjet mock [options]
program
  .command('mock')
  .description('üé≠ Start a local mock server with realistic API responses')
  .option('-p, --port <port>', 'Port to run mock server on (default: 3001)', '3001')
  .option('-s, --scenario <scenario>', 'Data scenario: demo|realistic|large|errors (default: demo)', 'demo')
  .option('-c, --config <path>', 'Path to configuration file')
  .addHelpText('after', `
Examples:
  $ specjet mock                       Start mock server on port 3001
  $ specjet mock --port 8080           Start mock server on custom port
  $ specjet mock --scenario realistic  Use varied, realistic data
  $ specjet mock --scenario large      Use large datasets for performance testing
  $ specjet mock --scenario errors     Include error responses for testing

Data Scenarios:
  ‚Ä¢ demo       Small, predictable data perfect for demos and presentations
  ‚Ä¢ realistic  Varied, realistic data that mimics production usage patterns
  ‚Ä¢ large      Large datasets for performance and load testing
  ‚Ä¢ errors     Mix of successful and error responses for robust testing

Features:
  ‚Ä¢ üåê REST API endpoints based on your OpenAPI contract
  ‚Ä¢ üöÄ Fast, realistic mock responses using faker.js
  ‚Ä¢ üåê CORS headers always enabled for frontend development
  ‚Ä¢ üìä Different data scenarios for comprehensive testing
  
  For API documentation, run: specjet docs --port 3002
`)
  .action(commands.mock);

// specjet docs [options]
program
  .command('docs')
  .description('üìñ Start a beautiful documentation server for your API')
  .option('-p, --port <port>', 'Port to run documentation server on (default: 3002)')
  .option('--open', 'Automatically open documentation in browser')
  .option('-o, --output <file>', 'Generate static HTML file instead of starting server (e.g. docs.html)')
  .option('-c, --config <path>', 'Path to configuration file')
  .addHelpText('after', `
Examples:
  $ specjet docs                       Start documentation server on port 3002
  $ specjet docs --port 8080           Start documentation server on custom port
  $ specjet docs --open                Start server and open in browser
  $ specjet docs --output docs.html    Generate static HTML file
  $ specjet docs --output ./dist/api-docs.html  Generate to custom path

Features:
  ‚Ä¢ üìñ Beautiful single-page documentation with all endpoints
  ‚Ä¢ üé® Dark/light theme toggle for comfortable viewing
  ‚Ä¢ üìã Clean sidebar navigation organized by endpoint categories  
  ‚Ä¢ üíª Copy-to-clipboard code examples (curl + TypeScript client)
  ‚Ä¢ üé≠ Mock data preview for each endpoint
  ‚Ä¢ üì± Responsive design that works on desktop and mobile
  ‚Ä¢ ‚ö° Zero dependencies - works offline as a single HTML file

Documentation Features:
  ‚Ä¢ üìä API overview with endpoint and schema statistics
  ‚Ä¢ üîó Complete endpoint documentation with parameters and responses
  ‚Ä¢ üìù Data model schemas with property descriptions and types
  ‚Ä¢ üéØ Smart code examples using your generated TypeScript client
  ‚Ä¢ üìã Clean mock response examples for development
`)
  .action(commands.docs);

// Future Phase 2 features - commented out for MVP
// 
// // specjet validate <api-url>
// program
//   .command('validate')
//   .description('üîç Validate a real API implementation against your contract (coming soon)')
//   .argument('<api-url>', 'Base URL of the API to validate (e.g., https://api.example.com)')
//   .option('-H, --header <header>', 'HTTP header to include (can be used multiple times)')
//   .option('--timeout <ms>', 'Request timeout in milliseconds (default: 5000)', '5000')
//   .addHelpText('after', `
// Examples:
//   $ specjet validate http://localhost:8000
//   $ specjet validate https://api.example.com
//   $ specjet validate https://api.example.com --header "Authorization: Bearer token123"
//   $ specjet validate https://api.example.com --header "X-API-Key: secret" --timeout 10000
// 
// What this validates:
//   ‚Ä¢ Endpoint availability (all paths return expected status codes)
//   ‚Ä¢ Response schema compliance (responses match OpenAPI schemas)  
//   ‚Ä¢ Required fields presence (all required fields are present)
//   ‚Ä¢ Data type correctness (field types match schema definitions)
//   ‚Ä¢ HTTP method support (endpoints support specified methods)
// 
// Note: This feature is planned for a future release.
// `)
//   .action(commands.validate);
// 
// // specjet sync (Future)
// program
//   .command('sync')
//   .description('üîÑ Sync contract from web platform (coming in Phase 2)')
//   .option('--force', 'Overwrite local changes without confirmation')
//   .option('--project <id>', 'Project ID to sync from (overrides config)')
//   .addHelpText('after', `
// Examples:
//   $ specjet sync                    Sync from linked project
//   $ specjet sync --force           Overwrite local changes
//   $ specjet sync --project proj_123 Sync from specific project
// 
// Note: This feature requires the SpecJet web platform (Phase 2).
//       Currently, SpecJet CLI works with local OpenAPI files only.
// `)
//   .action(commands.sync);

// Handle uncaught exceptions and rejections
process.on('uncaughtException', (error) => {
  console.error('\nüö® Uncaught Exception:');
  ErrorHandler.handle(error, { verbose: program.opts().verbose });
  process.exit(1);
});

process.on('unhandledRejection', (reason) => {
  console.error('\nüö® Unhandled Promise Rejection:');
  ErrorHandler.handle(reason, { verbose: program.opts().verbose });
  process.exit(1);
});

program.parse();